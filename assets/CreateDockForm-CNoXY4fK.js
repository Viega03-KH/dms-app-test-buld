import{k as R,U as j,y as N,u as O,x as P,d as D,l as T,a as b,o as _,b as m,g as i,h as k,f as t,X as E,D as z,q as $,v as S,F as H,B as I,c as B,j as C,r as x,w as Q}from"./index-B35B4UKf.js";import{u as X}from"./useFormValidate-Dp1VxGow.js";import{u as W,_ as G}from"./OrganizationForm-bRf4M0zG.js";import{u as Z}from"./doctypeStore-CBsTMrt2.js";import{u as ee}from"./deliveryStore-Bs9Gym3B.js";import{u as te}from"./jurnalStore-B9mFE900.js";import{_ as M}from"./UFileCard-DlH3otsj.js";import{C as le}from"./cloud-upload-DUMgMds6.js";import{P as ae}from"./plus-CnFSF54N.js";/**
 * @license lucide-vue-next v0.542.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const L=R("save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]),oe=({page:l=1,status:e=null,in_number:a=null,out_number:h=null}={})=>{const f={page:l};return e&&(f.status=e),a&&(f.in_number=a),h&&(f.out_number=h),j.get("/incomingdocuments/",{params:f})},re=l=>j.post("/incomingdocuments/",l),ie=(l,e)=>j.put(`/incomingdocuments/${l}/`,e),se=l=>j.get(`/incoming_document_show/${l}`),Y=N("dock",{state:()=>({docks:[],pagination:{previous:null,next:null,count:0,currentPage:1},selectedDock:null,loading:!1,error:null,status:"",in_number:"",out_number:""}),actions:{async fetchAll(l=1){this.loading=!0,this.error=null;try{const e=await oe({page:l,status:this.status,in_number:this.in_number,out_number:this.out_number});this.docks=e.data.results,this.pagination.count=e.data.count;const h=Math.ceil(e.data.count/10);this.pagination.currentPage=l,this.pagination.previous=l>1?l-1:null,this.pagination.next=l<h?l+1:null}catch(e){this.error=e.message}finally{this.loading=!1}},async createDock(l){this.loading=!0,this.error=null;try{const e=await re(l);if(e.status===200||e.status===201){const a=e.data;return this.docks.unshift(a),await this.fetchAll(),a}else this.error=e.data.message}catch(e){this.error=e?.message,console.error(e)}finally{this.loading=!1}},async updateDock(l,e){this.loading=!0,this.error=null;try{const a=await ie(l,e);a.status===200||a.status===201?await this.fetchAll():this.error=a.data.message}catch(a){this.error=a?.message,console.error(a)}finally{this.loading=!1}},async fetchDock(l){this.loading=!0;try{const e=await se(l);return this.selectedDock=e.data,e.data}catch(e){this.error=e.message}finally{this.loading=!1}}}}),ne=async({documentId:l,files:e})=>{if(!l)throw new Error("documentId is required");const a=new FormData;(Array.isArray(e)?e:[e]).forEach(p=>a.append("files",p)),a.append("document_id",l);const{data:f}=await j.post("/attachments/",a);return f},ue=l=>j.delete(`/attachments/${l}/`),de=N("attachment",{state:()=>({attachments:[],loading:!1}),actions:{async uploadFiles(l,e){if(!(!l||!e)){this.loading=!0;try{const a=await ne({documentId:l,files:e});return Array.isArray(a)&&a.length>0&&this.attachments.push(...a),a}catch(a){throw console.error("Attachment upload failed in store:",a),a}finally{this.loading=!1}}},async deleteAttachment(l){const e=O();if(l){this.loading=!0;try{await ue(l),this.attachments=this.attachments.filter(a=>a.id!==l),e.show("File o‘chirildi !")}catch(a){throw console.error("Attachment delete failed in store:",a),a}finally{this.loading=!1}}},setAttachments(l){Array.isArray(l)&&(this.attachments=l)}}}),ce={class:"w-[100vw] md:w-[40vw] 2xl:w-[40vw] h-[70vh] flex flex-col"},me={class:"flex justify-between modal-border items-center p-[14px] border-b"},pe={class:"p-6 w-full h-full overflow-y-scroll space-y-6"},he={class:"flex flex-col gap-2"},fe={key:0,class:"text-red-500 text-sm"},ye={key:1,class:"space-y-2 mt-2"},ge={key:2,class:"space-y-2 mt-2"},_e={class:"flex justify-end gap-3 p-4 border-t modal-border"},ve={__name:"CreateFileForm",props:{fileID:{type:Number,required:!1},file:{type:Object,required:!1}},setup(l){const e=l,a=P(),h=de(),f=Y(),p=D([]),g=D([]),v=D(!1),n=D({});T(()=>{e.file?.attachments?.length&&(g.value=[...e.file.attachments],h.setAttachments([...e.file.attachments]))});function o(){p.value=[],a.close()}function y(s){p.value.splice(s,1)}function A(s){h.deleteAttachment(s),g.value=g.value.filter(u=>u.id!==s)}function U(s){const u=Array.from(s.target.files);if(!u.length)return;const d=u.map(r=>Object.assign(r,{isLocal:!0}));p.value.push(...d),s.target.value=""}async function q(){if(!p.value.length&&!g.value.length){n.value.files="Iltimos, fayl tanlang";return}n.value.files=null,v.value=!0;try{if(p.value.length){const s=e.fileID||e.file?.id;if(!s)throw new Error("Document ID mavjud emas");await h.uploadFiles(s,p.value),f.fetchAll(),p.value=[]}(e.fileID||e.file?.id)&&f.fetchAll(),a.close()}catch(s){console.error("Fayl upload xatosi:",s)}finally{v.value=!1}}return(s,u)=>(_(),b("div",ce,[m("div",me,[u[3]||(u[3]=m("p",{class:"text-black text-md font-bold uppercase"},"Fayl qo'shish",-1)),i(z,{customClass:"bg-[#475467] rounded-full p-1",onClick:o},{default:k(()=>[i(t(E),{"stroke-width":"3",class:"w-3 h-3 text-white"})]),_:1})]),m("div",pe,[m("div",he,[m("div",{class:"flex flex-col border border-[#EAECF0] shadow-sm rounded-[12px] items-center text-center justify-center p-6 cursor-pointer hover:border-blue-400 transition-all active:scale-[0.90]",onDrop:u[0]||(u[0]=(...d)=>s.onDrop&&s.onDrop(...d)),onDragover:u[1]||(u[1]=(...d)=>s.onDragOver&&s.onDragOver(...d)),onClick:u[2]||(u[2]=d=>s.$refs.fileInput.click())},[i(t(le),{"stroke-width":"1",class:"w-10 h-10 text-blue-400"}),u[4]||(u[4]=m("p",{class:"text-gray-500 py-2"},"Fayllarni bu yerga torting yoki tanlang",-1)),m("input",{ref:"fileInput",type:"file",class:"hidden",multiple:!0,accept:".pdf,.docx,.jpg,.png",onChange:U},null,544)],32),n.value.files?(_(),b("p",fe,S(n.value.files),1)):$("",!0),p.value.length?(_(),b("div",ye,[(_(!0),b(H,null,I(p.value,(d,r)=>(_(),B(M,{key:d.name,file:d,"show-delete":!0,onRemove:()=>y(r)},null,8,["file","onRemove"]))),128))])):$("",!0),g.value.length?(_(),b("div",ge,[(_(!0),b(H,null,I(g.value,d=>(_(),B(M,{key:d.id,file:d,"show-delete":!0,onRemove:()=>A(d.id)},null,8,["file","onRemove"]))),128))])):$("",!0)])]),m("div",_e,[i(z,{variant:"ghost",onClick:o},{default:k(()=>[...u[5]||(u[5]=[C("Bekor qilish",-1)])]),_:1}),i(z,{variant:"primary",onClick:q,disabled:v.value,loading:v.value},{default:k(()=>[i(t(L)),C(" "+S(t(h).loading?"Yuborilmoqda...":"Saqlash va yuborish"),1)]),_:1},8,["disabled","loading"])])]))}},be={class:"w-[100vw] md:w-[90vw] 2xl:w-[70vw] h-[95vh] flex flex-col"},ke={class:"flex justify-between modal-border items-center p-[14px] border-b"},we={class:"text-black text-md font-bold uppercase"},je={class:"p-6 w-full h-full overflow-y-scroll space-y-6"},xe={class:"flex items-end gap-4 w-full"},qe={class:"flex-1 min-w-0"},Fe={class:"grid grid-cols-1 md:grid-cols-3 gap-[32px] flex-1 py-8"},Ve={class:"flex flex-col items-end justify-between gap-4"},De={class:"flex justify-end gap-3 p-4 border-t modal-border"},Me={__name:"CreateDockForm",props:{selectedFile:{type:Object,default:null}},setup(l){const e=Y(),a=P(),h=O(),f=W(),p=Z(),g=ee(),v=te(),n=l,{form:o,errors:y,validate:A,resetForm:U}=X({in_number:"",in_date:"",out_number:"",delivery_type_id:"",document_type_id:"",signer:"",journal_id:"",summary:"",title:"",sender_id:""},{in_number:{required:!0,message:"Kiruvchi raqam majburiy"},in_date:{required:!0,message:"Kiruvchi sana majburiy"},out_number:{required:!0,message:"Chiquvchi raqam majburiy"},delivery_type_id:{required:!0,message:"Yetkazish usulini tanlang"},document_type_id:{required:!0,message:"Hujjat turini tanlang"},signer:{required:!0,message:"Imzolovchi majburiy"},journal_id:{required:!0,message:"Jurnal majburiy"},summary:{required:!0,message:"Qisqacha mazmun majburiy"},title:{required:!0,message:"Hujjat nomi majburiy"},sender_id:{required:!0,message:"Ijrochi/Tashkilot majburiy"}});T(async()=>{try{await Promise.all([v.fetchAll(),f.fetchAll(),p.fetchAll(),g.fetchAll()]),n.selectedFile&&Object.assign(o,{in_number:n.selectedFile.in_number,in_date:n.selectedFile.in_date,out_number:n.selectedFile.out_number,delivery_type_id:n.selectedFile.delivery_type?.id||"",document_type_id:n.selectedFile.document_type?.id||"",signer:n.selectedFile.signer,journal_id:n.selectedFile.journal?.id||"",summary:n.selectedFile.summary,title:n.selectedFile.title,sender_id:n.selectedFile.sender?.id||""})}catch(d){console.error(d),h.show("Ma'lumotlarni yuklashda xatolik yuz berdi","error")}});const q=async()=>{if(!A())return;const d={in_number:o.in_number||null,in_date:o.in_date||null,out_number:o.out_number||null,signer:o.signer||null,title:o.title,summary:o.summary||null,delivery_type_id:o.delivery_type_id?Number(o.delivery_type_id):null,document_type_id:o.document_type_id?Number(o.document_type_id):null,journal_id:o.journal_id?Number(o.journal_id):null,sender_id:o.sender_id?Number(o.sender_id):null};try{if(e.loading=!0,n.selectedFile?.id)await e.updateDock(n.selectedFile.id,d),h.show("Hujjat muvaffaqiyatli yangilandi","success"),s();else{const r=await e.createDock(d);r&&r.id&&(h.show("Hujjat muvaffaqiyatli saqlandi","success"),a.close(),setTimeout(()=>{a.open(ve,{fileID:r.id})},400))}}catch(r){console.error("Xatolik tafsiloti:",r);const w=r.response?.data?Object.values(r.response.data).flat()[0]:"Hujjat saqlashda xatolik yuz berdi";h.show(w,"error")}finally{e.loading=!1}},s=()=>{U(),a.close()},u=()=>{a.open(G)};return(d,r)=>{const w=x("UButton"),F=x("USelect"),V=x("UInput"),J=x("UDatePicker"),K=x("UTextarea");return _(),b("div",be,[m("div",ke,[m("p",we,S(n.selectedFile?"Hujjatni tahrirlash":"Hujjat yaratish"),1),i(w,{customClass:"bg-[#475467] rounded-full p-1",onClick:s},{default:k(()=>[i(t(E),{"stroke-width":"3",class:"w-3 h-3 text-white"})]),_:1})]),m("div",je,[m("form",{onSubmit:Q(q,["prevent"]),class:"flex flex-col"},[m("div",xe,[m("div",qe,[i(F,{modelValue:t(o).sender_id,"onUpdate:modelValue":r[0]||(r[0]=c=>t(o).sender_id=c),options:t(f).organizations,label:"Tashkilot",placeholder:"Tashkilotni tanlang","option-label":"name","option-value":"id",loading:t(f).loading,error:t(y)?.sender_id},null,8,["modelValue","options","loading","error"])]),i(w,{onClick:u,variant:"primary",customClass:"w-1/4 py-4 flex-shrink-0"},{default:k(()=>[i(t(ae),{"stroke-width":"3"}),r[10]||(r[10]=m("span",{class:"px-2 whitespace-nowrap"},"Tashkilot qo‘shish",-1))]),_:1})]),m("div",Fe,[i(F,{modelValue:t(o).document_type_id,"onUpdate:modelValue":r[1]||(r[1]=c=>t(o).document_type_id=c),options:t(p).doctypes,label:"Hujjat turi",placeholder:"Hujjat turini tanlang","option-label":"name","option-value":"id",loading:t(p).loading,error:t(y)?.document_type_id},null,8,["modelValue","options","loading","error"]),i(F,{modelValue:t(o).journal_id,"onUpdate:modelValue":r[2]||(r[2]=c=>t(o).journal_id=c),options:t(v).jurnals,label:"Jurnal",placeholder:"Jurnal nomini kiriting","option-label":"name","option-value":"id",loading:t(v).loading,error:t(y)?.journal_id},null,8,["modelValue","options","loading","error"]),i(F,{modelValue:t(o).delivery_type_id,"onUpdate:modelValue":r[3]||(r[3]=c=>t(o).delivery_type_id=c),options:t(g).list,label:"Yetkazish usuli",placeholder:"Yetkazish usulini tanlang","option-label":"name","option-value":"id",loading:t(g).loading,error:t(y)?.delivery_type_id},null,8,["modelValue","options","loading","error"]),i(V,{modelValue:t(o).in_number,"onUpdate:modelValue":r[4]||(r[4]=c=>t(o).in_number=c),label:"Kiruvchi raqam",placeholder:"Kiruvchi raqamni kiriting",error:t(y)?.in_number},null,8,["modelValue","error"]),i(J,{modelValue:t(o).in_date,"onUpdate:modelValue":r[5]||(r[5]=c=>t(o).in_date=c),label:"Chiquvchi sana",placeholder:"Chiquvchi sana kiriting",error:t(y)?.in_date},null,8,["modelValue","error"]),i(V,{modelValue:t(o).out_number,"onUpdate:modelValue":r[6]||(r[6]=c=>t(o).out_number=c),label:"Chiquvchi raqam",placeholder:"Chiquvchi raqamni kiriting",error:t(y)?.out_number},null,8,["modelValue","error"]),i(V,{modelValue:t(o).signer,"onUpdate:modelValue":r[7]||(r[7]=c=>t(o).signer=c),label:"Imzolovchi",placeholder:"Imzolovchini kiriting",error:t(y)?.signer},null,8,["modelValue","error"])]),m("div",Ve,[i(V,{modelValue:t(o).title,"onUpdate:modelValue":r[8]||(r[8]=c=>t(o).title=c),label:"Hujjat nomi",placeholder:"Hujjat nomi kiriting",error:t(y)?.title},null,8,["modelValue","error"]),i(K,{modelValue:t(o).summary,"onUpdate:modelValue":r[9]||(r[9]=c=>t(o).summary=c),label:"Qisqacha mazmun",placeholder:"Hujjatning qisqacha mazmunini kiriting",error:t(y)?.summary},null,8,["modelValue","error"])])],32)]),m("div",De,[i(w,{variant:"ghost",onClick:s},{default:k(()=>[...r[11]||(r[11]=[C("Bekor qilish",-1)])]),_:1}),i(w,{variant:"primary",onClick:q,loading:t(e).loading},{default:k(()=>[i(t(L)),C(" "+S(t(p).loading?"Yuborilmoqda...":"Saqlash va fayil yuklash"),1)]),_:1},8,["loading"])])])}}};export{Me as _,ve as a,Y as u};
