import{R as x,y as I,u as P,x as E,d as S,l as M,a as w,o as v,b as m,g as n,h as j,f as l,D as z,q as H,v as C,F as N,C as O,c as T,j as A,r as F,w as K}from"./index-BtXiaCr0.js";import{X as L,u as Q}from"./useFormValidate-Db0qx1D3.js";import{u as X,_ as W}from"./OrganizationForm-BilCx8mc.js";import{u as G}from"./doctypeStore-eX6HsL5T.js";import{u as Z}from"./deliveryStore-DhUYZ18y.js";import{u as ee}from"./jurnalStore-CjknxKtK.js";import{_ as B}from"./UFileCard-D6XxzopN.js";import{C as te}from"./cloud-upload-DPlruAy0.js";import{P as le}from"./plus-308K3JGX.js";const re=({page:t=1,status:e=null,in_number:r=null,out_number:d=null}={})=>{const f={page:t};return e&&(f.status=e),r&&(f.in_number=r),d&&(f.out_number=d),x.get("/incomingdocuments/",{params:f})},oe=t=>x.post("/incomingdocuments/",t),ae=(t,e)=>x.put(`/incomingdocuments/${t}/`,e),ie=t=>x.get(`/incoming_document_show/${t}`),R=I("dock",{state:()=>({docks:[],pagination:{previous:null,next:null,count:0,currentPage:1},selectedDock:null,loading:!1,error:null,status:"",in_number:"",out_number:""}),actions:{async fetchAll(t=1){this.loading=!0,this.error=null;try{const e=await re({page:t,status:this.status,in_number:this.in_number,out_number:this.out_number});this.docks=e.data.results,this.pagination.count=e.data.count;const d=Math.ceil(e.data.count/10);this.pagination.currentPage=t,this.pagination.previous=t>1?t-1:null,this.pagination.next=t<d?t+1:null}catch(e){this.error=e.message}finally{this.loading=!1}},async createDock(t){this.loading=!0,this.error=null;try{const e=await oe(t);if(e.status===200||e.status===201){const r=e.data;return this.docks.unshift(r),await this.fetchAll(),r}else this.error=e.data.message}catch(e){this.error=e?.message,console.error(e)}finally{this.loading=!1}},async updateDock(t,e){this.loading=!0,this.error=null;try{const r=await ae(t,e);r.status===200||r.status===201?await this.fetchAll():this.error=r.data.message}catch(r){this.error=r?.message,console.error(r)}finally{this.loading=!1}},async fetchDock(t){this.loading=!0;try{const e=await ie(t);return this.selectedDock=e.data,e.data}catch(e){this.error=e.message}finally{this.loading=!1}}}}),se=(t,e)=>x.post(`file-upload?task_id=${e}`,t,{headers:{"Content-Type":"multipart/form-data"}}),ne=I("fileupload",{state:()=>({files:[],response:[],error:null}),actions:{setFiles(t){this.files=t},async upload(t){if(this.files.length){this.response=[],this.error=null;try{const e=new FormData;this.files.forEach(d=>{e.append("files[]",d)});const r=await se(e,t);return this.response=r.data||[],console.log(r.data),this.response}catch(e){throw this.error=e.response?.data||e.message||e,console.log(e.response?.data),this.error}}},clear(){this.files=[],this.response=[],this.error=null}}}),ue=async({documentId:t,files:e})=>{if(!t)throw new Error("documentId is required");const r=new FormData;(Array.isArray(e)?e:[e]).forEach(p=>r.append("files",p)),r.append("document_id",t);const{data:f}=await x.post("/attachments/",r);return f},de=t=>x.delete(`/attachments/${t}/`),ce=I("attachment",{state:()=>({attachments:[],loading:!1}),actions:{async uploadFiles(t,e){if(!(!t||!e)){this.loading=!0;try{const r=await ue({documentId:t,files:e});return Array.isArray(r)&&r.length>0&&this.attachments.push(...r),r}catch(r){throw console.error("Attachment upload failed in store:",r),r}finally{this.loading=!1}}},async deleteAttachment(t){const e=P();if(t){this.loading=!0;try{await de(t),this.attachments=this.attachments.filter(r=>r.id!==t),e.show("File oâ€˜chirildi !")}catch(r){throw console.error("Attachment delete failed in store:",r),r}finally{this.loading=!1}}},setAttachments(t){Array.isArray(t)&&(this.attachments=t)}}}),me={class:"w-[40vw] md:w-[40vw] 2xl:w-[40vw] h-auto flex flex-col"},pe={class:"flex justify-between modal-border items-center p-[14px] border-b"},he={class:"p-6 w-full h-full pb-10 overflow-y-scroll space-y-6"},fe={class:"flex flex-col gap-2"},ye={key:0,class:"text-red-500 text-sm"},ge={key:1,class:"space-y-2 mt-2"},_e={key:2,class:"space-y-2 mt-2"},ve={class:"flex justify-end gap-3 p-4 border-t modal-border"},be={__name:"CreateFileForm",props:{fileID:{type:Number,required:!1},file:{type:Object,required:!1}},setup(t){const e=t,r=E(),d=ce(),f=R(),p=S([]),g=S([]),k=S(!1),b=S({});M(()=>{e.file?.attachments?.length&&(g.value=[...e.file.attachments],d.setAttachments([...e.file.attachments]))});function c(){p.value=[],r.close()}function o(i){p.value.splice(i,1)}function y(i){d.deleteAttachment(i),g.value=g.value.filter(s=>s.id!==i)}function U(i){const s=Array.from(i.target.files);if(!s.length)return;const h=s.map(_=>Object.assign(_,{isLocal:!0}));p.value.push(...h),i.target.value=""}async function $(){if(!p.value.length&&!g.value.length){b.value.files="Iltimos, fayl tanlang";return}b.value.files=null,k.value=!0;try{if(p.value.length){const i=e.fileID||e.file?.id;if(!i)throw new Error("Document ID mavjud emas");await d.uploadFiles(i,p.value),f.fetchAll(),p.value=[]}(e.fileID||e.file?.id)&&f.fetchAll(),r.close()}catch(i){console.error("Fayl upload xatosi:",i)}finally{k.value=!1}}return(i,s)=>(v(),w("div",me,[m("div",pe,[s[3]||(s[3]=m("p",{class:"text-black text-md font-bold uppercase"},"Fayl qo'shish",-1)),n(z,{customClass:"bg-[#475467] rounded-full p-1",onClick:c},{default:j(()=>[n(l(L),{"stroke-width":"3",class:"w-3 h-3 text-white"})]),_:1})]),m("div",he,[m("div",fe,[m("div",{class:"flex flex-col border border-[#EAECF0] shadow-sm rounded-[12px] items-center text-center justify-center p-6 cursor-pointer hover:border-blue-400 transition-all active:scale-[0.90]",onDrop:s[0]||(s[0]=(...h)=>i.onDrop&&i.onDrop(...h)),onDragover:s[1]||(s[1]=(...h)=>i.onDragOver&&i.onDragOver(...h)),onClick:s[2]||(s[2]=h=>i.$refs.fileInput.click())},[n(l(te),{"stroke-width":"1",class:"w-10 h-10 text-gray-400"}),s[4]||(s[4]=m("p",{class:"text-gray-500 py-2"},"Fayllarni bu yerga torting yoki tanlang",-1)),m("input",{ref:"fileInput",type:"file",class:"hidden",multiple:!0,accept:".pdf,.docx,.jpg,.png",onChange:U},null,544)],32),b.value.files?(v(),w("p",ye,C(b.value.files),1)):H("",!0),p.value.length?(v(),w("div",ge,[(v(!0),w(N,null,O(p.value,(h,_)=>(v(),T(B,{key:h.name,file:h,"show-delete":!0,onRemove:()=>o(_)},null,8,["file","onRemove"]))),128))])):H("",!0),g.value.length?(v(),w("div",_e,[(v(!0),w(N,null,O(g.value,h=>(v(),T(B,{key:h.id,file:h,"show-delete":!0,onRemove:()=>y(h.id)},null,8,["file","onRemove"]))),128))])):H("",!0)])]),m("div",ve,[n(z,{variant:"ghost",onClick:c},{default:j(()=>[...s[5]||(s[5]=[A("Bekor qilish",-1)])]),_:1}),n(z,{variant:"primary",onClick:$,loading:k.value},{default:j(()=>[A(C(l(d).loading?"Yuborilmoqda...":"Saqlash va yuborish"),1)]),_:1},8,["loading"])])]))}},ke={class:"w-[100vw] md:w-[90vw] 2xl:w-[70vw] h-[95vh] flex flex-col"},we={class:"flex justify-between modal-border items-center p-[14px] border-b"},je={class:"text-black text-md font-bold uppercase"},xe={class:"p-6 w-full h-full overflow-y-scroll space-y-6"},qe={class:"flex flex-row items-end justify-between gap-4"},Fe={class:"grid grid-cols-1 md:grid-cols-3 gap-[32px] flex-1 py-8"},De={class:"flex flex-col items-end justify-between gap-4"},Ve={class:"flex justify-end gap-3 p-4 border-t modal-border"},Oe={__name:"CreateDockForm",props:{selectedFile:{type:Object,default:null}},setup(t){const e=R(),r=ne(),d=E(),f=P(),p=X(),g=G(),k=Z(),b=ee(),c=t,{form:o,errors:y,validate:U,resetForm:$}=Q({in_number:"",in_date:"",out_number:"",delivery_type_id:"",document_type_id:"",signer:"",journal_id:"",summary:"",title:"",sender_id:""},{in_number:{required:!0,message:"Kiruvchi raqam majburiy"},in_date:{required:!0,message:"Kiruvchi sana majburiy"},out_number:{required:!0,message:"Chiquvchi raqam majburiy"},delivery_type_id:{required:!0,message:"Yetkazish usulini tanlang"},document_type_id:{required:!0,message:"Hujjat turini tanlang"},signer:{required:!0,message:"Imzolovchi majburiy"},journal_id:{required:!0,message:"Jurnal majburiy"},summary:{required:!0,message:"Qisqacha mazmun majburiy"},title:{required:!0,message:"Hujjat nomi majburiy"},sender_id:{required:!0,message:"Ijrochi/Tashkilot majburiy"}});M(async()=>{try{await Promise.all([b.fetchAll(),p.fetchAll(),g.fetchAll(),k.fetchAll()]),c.selectedFile&&Object.assign(o,{in_number:c.selectedFile.in_number,in_date:c.selectedFile.in_date,out_number:c.selectedFile.out_number,delivery_type_id:c.selectedFile.delivery_type?.id||"",document_type_id:c.selectedFile.document_type?.id||"",signer:c.selectedFile.signer,journal_id:c.selectedFile.journal?.id||"",summary:c.selectedFile.summary,title:c.selectedFile.title,sender_id:c.selectedFile.sender?.id||""})}catch(_){console.error(_),f.show("Ma'lumotlarni yuklashda xatolik yuz berdi","error")}});const i=async()=>{if(!U())return;const _={in_number:o.in_number||null,in_date:o.in_date||null,out_number:o.out_number||null,signer:o.signer||null,title:o.title,summary:o.summary||null,delivery_type_id:o.delivery_type_id?Number(o.delivery_type_id):null,document_type_id:o.document_type_id?Number(o.document_type_id):null,journal_id:o.journal_id?Number(o.journal_id):null,sender_id:o.sender_id?Number(o.sender_id):null};try{if(e.loading=!0,c.selectedFile?.id)await e.updateDock(c.selectedFile.id,_),f.show("Hujjat muvaffaqiyatli yangilandi","success"),s();else{const a=await e.createDock(_);a&&a.id&&(f.show("Hujjat muvaffaqiyatli saqlandi","success"),d.close(),setTimeout(()=>{d.open(be,{fileID:a.id})},200))}}catch(a){console.error("Xatolik tafsiloti:",a);const q=a.response?.data?Object.values(a.response.data).flat()[0]:"Hujjat saqlashda xatolik yuz berdi";f.show(q,"error")}finally{e.loading=!1}},s=()=>{$(),r.clear(),d.close()},h=()=>{d.open(W)};return(_,a)=>{const q=F("UButton"),D=F("USelect"),V=F("UInput"),Y=F("UDatePicker"),J=F("UTextarea");return v(),w("div",ke,[m("div",we,[m("p",je,C(c.selectedFile?"Hujjatni tahrirlash":"Hujjat yaratish"),1),n(q,{customClass:"bg-[#475467] rounded-full p-1",onClick:s},{default:j(()=>[n(l(L),{"stroke-width":"3",class:"w-3 h-3 text-white"})]),_:1})]),m("div",xe,[m("form",{onSubmit:K(i,["prevent"]),class:"flex flex-col"},[m("div",qe,[n(D,{modelValue:l(o).sender_id,"onUpdate:modelValue":a[0]||(a[0]=u=>l(o).sender_id=u),options:l(p).organizations,label:"Tashkilot",placeholder:"Tashkilotni tanlang","option-label":"name","option-value":"id",loading:l(p).loading,error:l(y)?.sender_id},null,8,["modelValue","options","loading","error"]),n(q,{onClick:h,variant:"primary",customClass:"w-1/4 py-4"},{default:j(()=>[n(l(le),{"stroke-width":"3"}),a[10]||(a[10]=m("span",{class:"px-2"},"Tashkilot qo'shish",-1))]),_:1})]),m("div",Fe,[n(D,{modelValue:l(o).document_type_id,"onUpdate:modelValue":a[1]||(a[1]=u=>l(o).document_type_id=u),options:l(g).doctypes,label:"Hujjat turi",placeholder:"Hujjat turini tanlang","option-label":"name","option-value":"id",loading:l(g).loading,error:l(y)?.document_type_id},null,8,["modelValue","options","loading","error"]),n(D,{modelValue:l(o).journal_id,"onUpdate:modelValue":a[2]||(a[2]=u=>l(o).journal_id=u),options:l(b).jurnals,label:"Jurnal",placeholder:"Jurnal nomini kiriting","option-label":"name","option-value":"id",loading:l(b).loading,error:l(y)?.journal_id},null,8,["modelValue","options","loading","error"]),n(D,{modelValue:l(o).delivery_type_id,"onUpdate:modelValue":a[3]||(a[3]=u=>l(o).delivery_type_id=u),options:l(k).list,label:"Yetkazish usuli",placeholder:"Yetkazish usulini tanlang","option-label":"name","option-value":"id",loading:l(k).loading,error:l(y)?.delivery_type_id},null,8,["modelValue","options","loading","error"]),n(V,{modelValue:l(o).in_number,"onUpdate:modelValue":a[4]||(a[4]=u=>l(o).in_number=u),label:"Kiruvchi raqam",placeholder:"Kiruvchi raqamni kiriting",error:l(y)?.in_number},null,8,["modelValue","error"]),n(Y,{modelValue:l(o).in_date,"onUpdate:modelValue":a[5]||(a[5]=u=>l(o).in_date=u),label:"Chiquvchi sana",placeholder:"Chiquvchi sana kiriting",error:l(y)?.in_date},null,8,["modelValue","error"]),n(V,{modelValue:l(o).out_number,"onUpdate:modelValue":a[6]||(a[6]=u=>l(o).out_number=u),label:"Chiquvchi raqam",placeholder:"Chiquvchi raqamni kiriting",error:l(y)?.out_number},null,8,["modelValue","error"]),n(V,{modelValue:l(o).signer,"onUpdate:modelValue":a[7]||(a[7]=u=>l(o).signer=u),label:"Imzolovchi",placeholder:"Imzolovchini kiriting",error:l(y)?.signer},null,8,["modelValue","error"])]),m("div",De,[n(V,{modelValue:l(o).title,"onUpdate:modelValue":a[8]||(a[8]=u=>l(o).title=u),label:"Hujjat nomi",placeholder:"Hujjat nomi kiriting",error:l(y)?.title},null,8,["modelValue","error"]),n(J,{modelValue:l(o).summary,"onUpdate:modelValue":a[9]||(a[9]=u=>l(o).summary=u),label:"Qisqacha mazmun",placeholder:"Hujjatning qisqacha mazmunini kiriting",error:l(y)?.summary},null,8,["modelValue","error"])])],32)]),m("div",Ve,[n(q,{variant:"ghost",onClick:s},{default:j(()=>[...a[11]||(a[11]=[A("Bekor qilish",-1)])]),_:1}),n(q,{variant:"primary",onClick:i,loading:l(e).loading},{default:j(()=>[A(C(l(g).loading?"Yuborilmoqda...":"Saqlash va yuborish"),1)]),_:1},8,["loading"])])])}}};export{Oe as _,be as a,R as u};
