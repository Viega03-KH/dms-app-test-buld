import{U as x,y as I,u as P,x as E,d as S,l as M,a as w,o as v,b as d,g as n,h as j,f as l,D as z,q as H,v as C,F as N,C as O,c as T,j as A,r as F,w as R}from"./index-BTtPa-yH.js";import{X as L,u as Q}from"./useFormValidate-BxICouq_.js";import{u as X,_ as W}from"./OrganizationForm-C_fhc_bR.js";import{u as G}from"./doctypeStore-ZF0oN8n1.js";import{u as Z}from"./deliveryStore-C6Tm0tQ6.js";import{u as ee}from"./jurnalStore-CICs-GTa.js";import{_ as B}from"./UFileCard-C0S2SgjK.js";import{C as te}from"./cloud-upload-uRDo5Q5c.js";import{P as le}from"./plus-C_Yl-_57.js";const re=({page:t=1,status:e=null,in_number:r=null,out_number:c=null}={})=>{const f={page:t};return e&&(f.status=e),r&&(f.in_number=r),c&&(f.out_number=c),x.get("/incomingdocuments/",{params:f})},ae=t=>x.post("/incomingdocuments/",t),oe=(t,e)=>x.put(`/incomingdocuments/${t}/`,e),ie=t=>x.get(`/incoming_document_show/${t}`),Y=I("dock",{state:()=>({docks:[],pagination:{previous:null,next:null,count:0,currentPage:1},selectedDock:null,loading:!1,error:null,status:"",in_number:"",out_number:""}),actions:{async fetchAll(t=1){this.loading=!0,this.error=null;try{const e=await re({page:t,status:this.status,in_number:this.in_number,out_number:this.out_number});this.docks=e.data.results,this.pagination.count=e.data.count;const c=Math.ceil(e.data.count/10);this.pagination.currentPage=t,this.pagination.previous=t>1?t-1:null,this.pagination.next=t<c?t+1:null}catch(e){this.error=e.message}finally{this.loading=!1}},async createDock(t){this.loading=!0,this.error=null;try{const e=await ae(t);if(e.status===200||e.status===201){const r=e.data;return this.docks.unshift(r),await this.fetchAll(),r}else this.error=e.data.message}catch(e){this.error=e?.message,console.error(e)}finally{this.loading=!1}},async updateDock(t,e){this.loading=!0,this.error=null;try{const r=await oe(t,e);r.status===200||r.status===201?await this.fetchAll():this.error=r.data.message}catch(r){this.error=r?.message,console.error(r)}finally{this.loading=!1}},async fetchDock(t){this.loading=!0;try{const e=await ie(t);return this.selectedDock=e.data,e.data}catch(e){this.error=e.message}finally{this.loading=!1}}}}),se=(t,e)=>x.post(`file-upload?task_id=${e}`,t,{headers:{"Content-Type":"multipart/form-data"}}),ne=I("fileupload",{state:()=>({files:[],response:[],error:null}),actions:{setFiles(t){this.files=t},async upload(t){if(this.files.length){this.response=[],this.error=null;try{const e=new FormData;this.files.forEach(c=>{e.append("files[]",c)});const r=await se(e,t);return this.response=r.data||[],console.log(r.data),this.response}catch(e){throw this.error=e.response?.data||e.message||e,console.log(e.response?.data),this.error}}},clear(){this.files=[],this.response=[],this.error=null}}}),ue=async({documentId:t,files:e})=>{if(!t)throw new Error("documentId is required");const r=new FormData;(Array.isArray(e)?e:[e]).forEach(p=>r.append("files",p)),r.append("document_id",t);const{data:f}=await x.post("/attachments/",r);return f},de=t=>x.delete(`/attachments/${t}/`),ce=I("attachment",{state:()=>({attachments:[],loading:!1}),actions:{async uploadFiles(t,e){if(!(!t||!e)){this.loading=!0;try{const r=await ue({documentId:t,files:e});return Array.isArray(r)&&r.length>0&&this.attachments.push(...r),r}catch(r){throw console.error("Attachment upload failed in store:",r),r}finally{this.loading=!1}}},async deleteAttachment(t){const e=P();if(t){this.loading=!0;try{await de(t),this.attachments=this.attachments.filter(r=>r.id!==t),e.show("File o‘chirildi !")}catch(r){throw console.error("Attachment delete failed in store:",r),r}finally{this.loading=!1}}},setAttachments(t){Array.isArray(t)&&(this.attachments=t)}}}),me={class:"w-[40vw] md:w-[40vw] 2xl:w-[40vw] h-auto flex flex-col"},pe={class:"flex justify-between modal-border items-center p-[14px] border-b"},he={class:"p-6 w-full h-full pb-10 overflow-y-scroll space-y-6"},fe={class:"flex flex-col gap-2"},ye={key:0,class:"text-red-500 text-sm"},ge={key:1,class:"space-y-2 mt-2"},_e={key:2,class:"space-y-2 mt-2"},ve={class:"flex justify-end gap-3 p-4 border-t modal-border"},be={__name:"CreateFileForm",props:{fileID:{type:Number,required:!1},file:{type:Object,required:!1}},setup(t){const e=t,r=E(),c=ce(),f=Y(),p=S([]),g=S([]),k=S(!1),b=S({});M(()=>{e.file?.attachments?.length&&(g.value=[...e.file.attachments],c.setAttachments([...e.file.attachments]))});function m(){p.value=[],r.close()}function a(i){p.value.splice(i,1)}function y(i){c.deleteAttachment(i),g.value=g.value.filter(s=>s.id!==i)}function U(i){const s=Array.from(i.target.files);if(!s.length)return;const h=s.map(_=>Object.assign(_,{isLocal:!0}));p.value.push(...h),i.target.value=""}async function $(){if(!p.value.length&&!g.value.length){b.value.files="Iltimos, fayl tanlang";return}b.value.files=null,k.value=!0;try{if(p.value.length){const i=e.fileID||e.file?.id;if(!i)throw new Error("Document ID mavjud emas");await c.uploadFiles(i,p.value),f.fetchAll(),p.value=[]}(e.fileID||e.file?.id)&&f.fetchAll(),r.close()}catch(i){console.error("Fayl upload xatosi:",i)}finally{k.value=!1}}return(i,s)=>(v(),w("div",me,[d("div",pe,[s[3]||(s[3]=d("p",{class:"text-black text-md font-bold uppercase"},"Fayl qo'shish",-1)),n(z,{customClass:"bg-[#475467] rounded-full p-1",onClick:m},{default:j(()=>[n(l(L),{"stroke-width":"3",class:"w-3 h-3 text-white"})]),_:1})]),d("div",he,[d("div",fe,[d("div",{class:"flex flex-col border border-[#EAECF0] shadow-sm rounded-[12px] items-center text-center justify-center p-6 cursor-pointer hover:border-blue-400 transition-all active:scale-[0.90]",onDrop:s[0]||(s[0]=(...h)=>i.onDrop&&i.onDrop(...h)),onDragover:s[1]||(s[1]=(...h)=>i.onDragOver&&i.onDragOver(...h)),onClick:s[2]||(s[2]=h=>i.$refs.fileInput.click())},[n(l(te),{"stroke-width":"1",class:"w-10 h-10 text-gray-400"}),s[4]||(s[4]=d("p",{class:"text-gray-500 py-2"},"Fayllarni bu yerga torting yoki tanlang",-1)),d("input",{ref:"fileInput",type:"file",class:"hidden",multiple:!0,accept:".pdf,.docx,.jpg,.png",onChange:U},null,544)],32),b.value.files?(v(),w("p",ye,C(b.value.files),1)):H("",!0),p.value.length?(v(),w("div",ge,[(v(!0),w(N,null,O(p.value,(h,_)=>(v(),T(B,{key:h.name,file:h,"show-delete":!0,onRemove:()=>a(_)},null,8,["file","onRemove"]))),128))])):H("",!0),g.value.length?(v(),w("div",_e,[(v(!0),w(N,null,O(g.value,h=>(v(),T(B,{key:h.id,file:h,"show-delete":!0,onRemove:()=>y(h.id)},null,8,["file","onRemove"]))),128))])):H("",!0)])]),d("div",ve,[n(z,{variant:"ghost",onClick:m},{default:j(()=>[...s[5]||(s[5]=[A("Bekor qilish",-1)])]),_:1}),n(z,{variant:"primary",onClick:$,loading:k.value},{default:j(()=>[A(C(l(c).loading?"Yuborilmoqda...":"Saqlash va yuborish"),1)]),_:1},8,["loading"])])]))}},ke={class:"w-[100vw] md:w-[90vw] 2xl:w-[70vw] h-[95vh] flex flex-col"},we={class:"flex justify-between modal-border items-center p-[14px] border-b"},je={class:"text-black text-md font-bold uppercase"},xe={class:"p-6 w-full h-full overflow-y-scroll space-y-6"},qe={class:"flex items-end gap-4 w-full"},Fe={class:"flex-1 min-w-0"},De={class:"grid grid-cols-1 md:grid-cols-3 gap-[32px] flex-1 py-8"},Ve={class:"flex flex-col items-end justify-between gap-4"},Se={class:"flex justify-end gap-3 p-4 border-t modal-border"},Te={__name:"CreateDockForm",props:{selectedFile:{type:Object,default:null}},setup(t){const e=Y(),r=ne(),c=E(),f=P(),p=X(),g=G(),k=Z(),b=ee(),m=t,{form:a,errors:y,validate:U,resetForm:$}=Q({in_number:"",in_date:"",out_number:"",delivery_type_id:"",document_type_id:"",signer:"",journal_id:"",summary:"",title:"",sender_id:""},{in_number:{required:!0,message:"Kiruvchi raqam majburiy"},in_date:{required:!0,message:"Kiruvchi sana majburiy"},out_number:{required:!0,message:"Chiquvchi raqam majburiy"},delivery_type_id:{required:!0,message:"Yetkazish usulini tanlang"},document_type_id:{required:!0,message:"Hujjat turini tanlang"},signer:{required:!0,message:"Imzolovchi majburiy"},journal_id:{required:!0,message:"Jurnal majburiy"},summary:{required:!0,message:"Qisqacha mazmun majburiy"},title:{required:!0,message:"Hujjat nomi majburiy"},sender_id:{required:!0,message:"Ijrochi/Tashkilot majburiy"}});M(async()=>{try{await Promise.all([b.fetchAll(),p.fetchAll(),g.fetchAll(),k.fetchAll()]),m.selectedFile&&Object.assign(a,{in_number:m.selectedFile.in_number,in_date:m.selectedFile.in_date,out_number:m.selectedFile.out_number,delivery_type_id:m.selectedFile.delivery_type?.id||"",document_type_id:m.selectedFile.document_type?.id||"",signer:m.selectedFile.signer,journal_id:m.selectedFile.journal?.id||"",summary:m.selectedFile.summary,title:m.selectedFile.title,sender_id:m.selectedFile.sender?.id||""})}catch(_){console.error(_),f.show("Ma'lumotlarni yuklashda xatolik yuz berdi","error")}});const i=async()=>{if(!U())return;const _={in_number:a.in_number||null,in_date:a.in_date||null,out_number:a.out_number||null,signer:a.signer||null,title:a.title,summary:a.summary||null,delivery_type_id:a.delivery_type_id?Number(a.delivery_type_id):null,document_type_id:a.document_type_id?Number(a.document_type_id):null,journal_id:a.journal_id?Number(a.journal_id):null,sender_id:a.sender_id?Number(a.sender_id):null};try{if(e.loading=!0,m.selectedFile?.id)await e.updateDock(m.selectedFile.id,_),f.show("Hujjat muvaffaqiyatli yangilandi","success"),s();else{const o=await e.createDock(_);o&&o.id&&(f.show("Hujjat muvaffaqiyatli saqlandi","success"),c.close(),setTimeout(()=>{c.open(be,{fileID:o.id})},400))}}catch(o){console.error("Xatolik tafsiloti:",o);const q=o.response?.data?Object.values(o.response.data).flat()[0]:"Hujjat saqlashda xatolik yuz berdi";f.show(q,"error")}finally{e.loading=!1}},s=()=>{$(),r.clear(),c.close()},h=()=>{c.open(W)};return(_,o)=>{const q=F("UButton"),D=F("USelect"),V=F("UInput"),J=F("UDatePicker"),K=F("UTextarea");return v(),w("div",ke,[d("div",we,[d("p",je,C(m.selectedFile?"Hujjatni tahrirlash":"Hujjat yaratish"),1),n(q,{customClass:"bg-[#475467] rounded-full p-1",onClick:s},{default:j(()=>[n(l(L),{"stroke-width":"3",class:"w-3 h-3 text-white"})]),_:1})]),d("div",xe,[d("form",{onSubmit:R(i,["prevent"]),class:"flex flex-col"},[d("div",qe,[d("div",Fe,[n(D,{modelValue:l(a).sender_id,"onUpdate:modelValue":o[0]||(o[0]=u=>l(a).sender_id=u),options:l(p).organizations,label:"Tashkilot",placeholder:"Tashkilotni tanlang","option-label":"name","option-value":"id",loading:l(p).loading,error:l(y)?.sender_id},null,8,["modelValue","options","loading","error"])]),n(q,{onClick:h,variant:"primary",customClass:"w-1/4 py-4 flex-shrink-0"},{default:j(()=>[n(l(le),{"stroke-width":"3"}),o[10]||(o[10]=d("span",{class:"px-2 whitespace-nowrap"},"Tashkilot qo‘shish",-1))]),_:1})]),d("div",De,[n(D,{modelValue:l(a).document_type_id,"onUpdate:modelValue":o[1]||(o[1]=u=>l(a).document_type_id=u),options:l(g).doctypes,label:"Hujjat turi",placeholder:"Hujjat turini tanlang","option-label":"name","option-value":"id",loading:l(g).loading,error:l(y)?.document_type_id},null,8,["modelValue","options","loading","error"]),n(D,{modelValue:l(a).journal_id,"onUpdate:modelValue":o[2]||(o[2]=u=>l(a).journal_id=u),options:l(b).jurnals,label:"Jurnal",placeholder:"Jurnal nomini kiriting","option-label":"name","option-value":"id",loading:l(b).loading,error:l(y)?.journal_id},null,8,["modelValue","options","loading","error"]),n(D,{modelValue:l(a).delivery_type_id,"onUpdate:modelValue":o[3]||(o[3]=u=>l(a).delivery_type_id=u),options:l(k).list,label:"Yetkazish usuli",placeholder:"Yetkazish usulini tanlang","option-label":"name","option-value":"id",loading:l(k).loading,error:l(y)?.delivery_type_id},null,8,["modelValue","options","loading","error"]),n(V,{modelValue:l(a).in_number,"onUpdate:modelValue":o[4]||(o[4]=u=>l(a).in_number=u),label:"Kiruvchi raqam",placeholder:"Kiruvchi raqamni kiriting",error:l(y)?.in_number},null,8,["modelValue","error"]),n(J,{modelValue:l(a).in_date,"onUpdate:modelValue":o[5]||(o[5]=u=>l(a).in_date=u),label:"Chiquvchi sana",placeholder:"Chiquvchi sana kiriting",error:l(y)?.in_date},null,8,["modelValue","error"]),n(V,{modelValue:l(a).out_number,"onUpdate:modelValue":o[6]||(o[6]=u=>l(a).out_number=u),label:"Chiquvchi raqam",placeholder:"Chiquvchi raqamni kiriting",error:l(y)?.out_number},null,8,["modelValue","error"]),n(V,{modelValue:l(a).signer,"onUpdate:modelValue":o[7]||(o[7]=u=>l(a).signer=u),label:"Imzolovchi",placeholder:"Imzolovchini kiriting",error:l(y)?.signer},null,8,["modelValue","error"])]),d("div",Ve,[n(V,{modelValue:l(a).title,"onUpdate:modelValue":o[8]||(o[8]=u=>l(a).title=u),label:"Hujjat nomi",placeholder:"Hujjat nomi kiriting",error:l(y)?.title},null,8,["modelValue","error"]),n(K,{modelValue:l(a).summary,"onUpdate:modelValue":o[9]||(o[9]=u=>l(a).summary=u),label:"Qisqacha mazmun",placeholder:"Hujjatning qisqacha mazmunini kiriting",error:l(y)?.summary},null,8,["modelValue","error"])])],32)]),d("div",Se,[n(q,{variant:"ghost",onClick:s},{default:j(()=>[...o[11]||(o[11]=[A("Bekor qilish",-1)])]),_:1}),n(q,{variant:"primary",onClick:i,loading:l(e).loading},{default:j(()=>[A(C(l(g).loading?"Yuborilmoqda...":"Saqlash va fayil yuklash"),1)]),_:1},8,["loading"])])])}}};export{Te as _,be as a,Y as u};
