import{d as e,j as a,z as l,c as t,o as i,e as r,b as n,w as s,u as o,a as u,t as d,F as c,r as m,f as h,N as p,B as g,x as f}from"./vue-vendor-VaL6RChx.js";import{u as y}from"./useFormValidate-Wk5HUh9e.js";import{u as _,_ as v}from"./OrganizationForm-DQgRJ6O4.js";import{h as b,u as j,b as w,d as k}from"./index-hOpDXQV6.js";import{u as x}from"./doctypeStore-CGeV6rfE.js";import{u as q}from"./deliveryStore-CfqNtQW-.js";import{u as V}from"./jurnalStore-B7ZqSZOS.js";import{_ as F}from"./UFileCard-CX6bBOqm.js";import{X as D,D as A,J as C,P as U}from"./ui-vendor-DFLFBWqj.js";const I=e("dock",{state:()=>({docks:[],pagination:{previous:null,next:null,count:0,currentPage:1},selectedDock:null,loading:!1,error:null,status:"",in_number:"",out_number:""}),actions:{async fetchAll(e=1){this.loading=!0,this.error=null;try{const a=await(({page:e=1,status:a=null,in_number:l=null,out_number:t=null}={})=>{const i={page:e};return a&&(i.status=a),l&&(i.in_number=l),t&&(i.out_number=t),b.get("/incomingdocuments/",{params:i})})({page:e,status:this.status,in_number:this.in_number,out_number:this.out_number});this.docks=a.data.results,this.pagination.count=a.data.count;const l=10,t=Math.ceil(a.data.count/l);this.pagination.currentPage=e,this.pagination.previous=e>1?e-1:null,this.pagination.next=e<t?e+1:null}catch(a){this.error=a.message}finally{this.loading=!1}},async createDock(e){this.loading=!0,this.error=null;try{const a=await(e=>b.post("/incomingdocuments/",e))(e);if(200===a.status||201===a.status){const e=a.data;return this.docks.unshift(e),await this.fetchAll(),e}this.error=a.data.message}catch(a){this.error=a?.message}finally{this.loading=!1}},async updateDock(e,a){this.loading=!0,this.error=null;try{const l=await((e,a)=>b.put(`/incomingdocuments/${e}/`,a))(e,a);200===l.status||201===l.status?await this.fetchAll():this.error=l.data.message}catch(l){this.error=l?.message}finally{this.loading=!1}},async fetchDock(e){this.loading=!0;try{const a=await(e=>b.get(`/incoming_document_show/${e}`))(e);return this.selectedDock=a.data,a.data}catch(a){this.error=a.message}finally{this.loading=!1}}}}),z=e("attachment",{state:()=>({attachments:[],loading:!1}),actions:{async uploadFiles(e,a){if(e&&a){this.loading=!0;try{const l=await(async({documentId:e,files:a})=>{if(!e)throw new Error("documentId is required");const l=new FormData;(Array.isArray(a)?a:[a]).forEach(e=>l.append("files",e)),l.append("document_id",e);const{data:t}=await b.post("/attachments/",l);return t})({documentId:e,files:a});return Array.isArray(l)&&l.length>0&&this.attachments.push(...l),l}catch(l){throw l}finally{this.loading=!1}}},async deleteAttachment(e){const a=j();if(e){this.loading=!0;try{await(l=e,b.delete(`/attachments/${l}/`)),this.attachments=this.attachments.filter(a=>a.id!==e),a.show("File o‘chirildi !")}catch(t){throw t}finally{this.loading=!1}var l}},setAttachments(e){Array.isArray(e)&&(this.attachments=e)}}}),H={class:"w-[100vw] md:w-[40vw] 2xl:w-[40vw] h-[70vh] flex flex-col"},O={class:"flex justify-between modal-border items-center p-[14px] border-b"},S={class:"p-6 w-full h-full overflow-y-scroll space-y-6"},N={class:"flex flex-col gap-2"},T={key:0,class:"text-red-500 text-sm"},B={key:1,class:"space-y-2 mt-2"},E={key:2,class:"space-y-2 mt-2"},P={class:"flex justify-end gap-3 p-4 border-t modal-border"},Y={__name:"CreateFileForm",props:{fileID:{type:Number,required:!1},file:{type:Object,required:!1}},setup(e){const g=e,f=w(),y=z(),_=I(),v=j(),b=a([]),x=a([]),q=a(!1),V=a({});function U(){b.value=[],f.close()}function Y(e){const a=Array.from(e.target.files);if(!a.length)return;const l=[],t=[];for(const i of a)i.size<=20971520?l.push(Object.assign(i,{isLocal:!0})):t.push(i);l.length&&b.value.push(...l),t.length&&(t.map(e=>e.name).join(", "),v.show("Ushbu fayllar 20 MB dan katta bo'lganligi sababli yuklanmadi")),e.target.value=""}async function J(){if(b.value.length||x.value.length){V.value.files=null,q.value=!0;try{if(b.value.length){const e=g.fileID||g.file?.id;if(!e)throw new Error("Document ID mavjud emas");await y.uploadFiles(e,b.value),_.fetchAll(),b.value=[]}(g.fileID||g.file?.id)&&_.fetchAll(),f.close()}catch(e){}finally{q.value=!1}}else V.value.files="Iltimos, fayl tanlang"}return l(()=>{g.file?.attachments?.length&&(x.value=[...g.file.attachments],y.setAttachments([...g.file.attachments]))}),(e,a)=>(i(),t("div",H,[r("div",O,[a[3]||(a[3]=r("p",{class:"text-black text-md font-bold uppercase"},"Fayl qo'shish",-1)),n(k,{customClass:"bg-[#475467] rounded-full p-1",onClick:U},{default:s(()=>[n(o(D),{"stroke-width":"3",class:"w-3 h-3 text-white"})]),_:1})]),r("div",S,[r("div",N,[r("div",{class:"flex flex-col border border-[#EAECF0] shadow-sm rounded-[12px] items-center text-center justify-center p-6 cursor-pointer hover:border-blue-400 transition-all active:scale-[0.90]",onDrop:a[0]||(a[0]=(...a)=>e.onDrop&&e.onDrop(...a)),onDragover:a[1]||(a[1]=(...a)=>e.onDragOver&&e.onDragOver(...a)),onClick:a[2]||(a[2]=a=>e.$refs.fileInput.click())},[n(o(A),{"stroke-width":"1",class:"w-10 h-10 text-blue-400"}),a[4]||(a[4]=r("p",{class:"text-gray-500 py-2"},"Fayllarni bu yerga torting yoki tanlang",-1)),r("input",{ref:"fileInput",type:"file",class:"hidden",multiple:!0,accept:".pdf,.docx,.jpg,.png",onChange:Y},null,544)],32),V.value.files?(i(),t("p",T,d(V.value.files),1)):u("",!0),b.value.length?(i(),t("div",B,[(i(!0),t(c,null,m(b.value,(e,a)=>(i(),h(F,{key:e.name,file:e,"show-delete":!0,onRemove:()=>function(e){b.value.splice(e,1)}(a)},null,8,["file","onRemove"]))),128))])):u("",!0),x.value.length?(i(),t("div",E,[(i(!0),t(c,null,m(x.value,e=>(i(),h(F,{key:e.id,file:e,"show-delete":!0,onRemove:()=>{return a=e.id,y.deleteAttachment(a),void(x.value=x.value.filter(e=>e.id!==a));var a}},null,8,["file","onRemove"]))),128))])):u("",!0)])]),r("div",P,[n(k,{variant:"ghost",onClick:U},{default:s(()=>[...a[5]||(a[5]=[p("Bekor qilish",-1)])]),_:1}),n(k,{variant:"primary",onClick:J,disabled:q.value,loading:q.value},{default:s(()=>[n(o(C)),p(" "+d(o(y).loading?"Yuborilmoqda...":"Saqlash va yuborish"),1)]),_:1},8,["disabled","loading"])])]))}},J={class:"w-[100vw] md:w-[90vw] 2xl:w-[70vw] h-[95vh] flex flex-col"},K={class:"flex justify-between modal-border items-center p-[14px] border-b"},R={class:"text-gray-600 text-sm font-bold uppercase"},$={class:"p-6 w-full h-full overflow-y-scroll space-y-6"},M={class:"flex items-end gap-4 w-full"},Q={class:"flex-1 min-w-0"},L={class:"grid grid-cols-1 md:grid-cols-3 gap-[32px] flex-1 py-8"},G={class:"flex flex-col items-end justify-between gap-4"},W={class:"flex justify-end gap-3 p-4 border-t modal-border"},X={__name:"CreateDockForm",props:{selectedFile:{type:Object,default:null}},setup(e){const a=I(),u=w(),c=j(),m=_(),h=x(),b=q(),k=V(),F=e,{form:A,errors:z,validate:H,resetForm:O}=y({in_number:"",in_date:"",out_number:"",delivery_type_id:"",document_type_id:"",signer:"",journal_id:"",summary:"",title:"",sender_id:""},{in_number:{required:!0,message:"Kiruvchi raqam majburiy"},in_date:{required:!0,message:"Kiruvchi sana majburiy"},out_number:{required:!0,message:"Chiquvchi raqam majburiy"},delivery_type_id:{required:!0,message:"Yetkazish usulini tanlang"},document_type_id:{required:!0,message:"Hujjat turini tanlang"},signer:{required:!0,message:"Imzolovchi majburiy"},journal_id:{required:!0,message:"Jurnal majburiy"},summary:{required:!0,message:"Qisqacha mazmun majburiy"},title:{required:!0,message:"Hujjat nomi majburiy"},sender_id:{required:!0,message:"Ijrochi/Tashkilot majburiy"}});l(async()=>{try{await Promise.all([k.fetchAll(),m.fetchAll(),h.fetchAll(),b.fetchAll()]),F.selectedFile&&Object.assign(A,{in_number:F.selectedFile.in_number,in_date:F.selectedFile.in_date,out_number:F.selectedFile.out_number,delivery_type_id:F.selectedFile.delivery_type?.id||"",document_type_id:F.selectedFile.document_type?.id||"",signer:F.selectedFile.signer,journal_id:F.selectedFile.journal?.id||"",summary:F.selectedFile.summary,title:F.selectedFile.title,sender_id:F.selectedFile.sender?.id||""})}catch(e){c.show("Ma'lumotlarni yuklashda xatolik yuz berdi","error")}});const S=async()=>{if(!H())return;const e={in_number:A.in_number||null,in_date:A.in_date||null,out_number:A.out_number||null,signer:A.signer||null,title:A.title,summary:A.summary||null,delivery_type_id:A.delivery_type_id?Number(A.delivery_type_id):null,document_type_id:A.document_type_id?Number(A.document_type_id):null,journal_id:A.journal_id?Number(A.journal_id):null,sender_id:A.sender_id?Number(A.sender_id):null};try{if(a.loading=!0,F.selectedFile?.id)await a.updateDock(F.selectedFile.id,e),c.show("Hujjat muvaffaqiyatli yangilandi","success"),N();else{const l=await a.createDock(e);l&&l.id&&(c.show("Hujjat muvaffaqiyatli saqlandi","success"),u.close(),setTimeout(()=>{u.open(Y,{fileID:l.id})},400))}}catch(l){const e=l.response?.data?Object.values(l.response.data).flat()[0]:"Hujjat saqlashda xatolik yuz berdi";c.show(e,"error")}finally{a.loading=!1}},N=()=>{O(),u.close()},T=()=>{u.open(v)};return(e,l)=>{const u=g("UButton"),c=g("USelect"),y=g("UInput"),_=g("UDatePicker"),v=g("UTextarea");return i(),t("div",J,[r("div",K,[r("p",R,d(F.selectedFile?"Hujjatni tahrirlash":"Hujjat yaratish"),1),n(u,{customClass:"bg-gray-400 rounded-full p-1",onClick:N},{default:s(()=>[n(o(D),{"stroke-width":"3",class:"w-3 h-3 text-white"})]),_:1})]),r("div",$,[r("form",{onSubmit:f(S,["prevent"]),class:"flex flex-col"},[r("div",M,[r("div",Q,[n(c,{modelValue:o(A).sender_id,"onUpdate:modelValue":l[0]||(l[0]=e=>o(A).sender_id=e),options:o(m).organizations,label:"Tashkilot",placeholder:"Tashkilotni tanlang","option-label":"name","option-value":"id",loading:o(m).loading,error:o(z)?.sender_id},null,8,["modelValue","options","loading","error"])]),n(u,{onClick:T,variant:"primary",customClass:"w-1/4 py-4 flex-shrink-0"},{default:s(()=>[n(o(U),{"stroke-width":"3"}),l[10]||(l[10]=r("span",{class:"px-2 whitespace-nowrap"},"Tashkilot qo‘shish",-1))]),_:1})]),r("div",L,[n(c,{modelValue:o(A).document_type_id,"onUpdate:modelValue":l[1]||(l[1]=e=>o(A).document_type_id=e),options:o(h).doctypes,label:"Hujjat turi",placeholder:"Hujjat turini tanlang","option-label":"name","option-value":"id",loading:o(h).loading,error:o(z)?.document_type_id},null,8,["modelValue","options","loading","error"]),n(c,{modelValue:o(A).journal_id,"onUpdate:modelValue":l[2]||(l[2]=e=>o(A).journal_id=e),options:o(k).jurnals,label:"Jurnal",placeholder:"Jurnal nomini kiriting","option-label":"name","option-value":"id",loading:o(k).loading,error:o(z)?.journal_id},null,8,["modelValue","options","loading","error"]),n(c,{modelValue:o(A).delivery_type_id,"onUpdate:modelValue":l[3]||(l[3]=e=>o(A).delivery_type_id=e),options:o(b).list,label:"Yetkazish usuli",placeholder:"Yetkazish usulini tanlang","option-label":"name","option-value":"id",loading:o(b).loading,error:o(z)?.delivery_type_id},null,8,["modelValue","options","loading","error"]),n(y,{modelValue:o(A).in_number,"onUpdate:modelValue":l[4]||(l[4]=e=>o(A).in_number=e),label:"Kiruvchi raqam",placeholder:"Kiruvchi raqamni kiriting",error:o(z)?.in_number},null,8,["modelValue","error"]),n(_,{modelValue:o(A).in_date,"onUpdate:modelValue":l[5]||(l[5]=e=>o(A).in_date=e),label:"Chiquvchi sana",placeholder:"Chiquvchi sana kiriting",error:o(z)?.in_date},null,8,["modelValue","error"]),n(y,{modelValue:o(A).out_number,"onUpdate:modelValue":l[6]||(l[6]=e=>o(A).out_number=e),label:"Chiquvchi raqam",placeholder:"Chiquvchi raqamni kiriting",error:o(z)?.out_number},null,8,["modelValue","error"]),n(y,{modelValue:o(A).signer,"onUpdate:modelValue":l[7]||(l[7]=e=>o(A).signer=e),label:"Imzolovchi",placeholder:"Imzolovchini kiriting",error:o(z)?.signer},null,8,["modelValue","error"])]),r("div",G,[n(y,{modelValue:o(A).title,"onUpdate:modelValue":l[8]||(l[8]=e=>o(A).title=e),label:"Hujjat nomi",placeholder:"Hujjat nomi kiriting",error:o(z)?.title},null,8,["modelValue","error"]),n(v,{modelValue:o(A).summary,"onUpdate:modelValue":l[9]||(l[9]=e=>o(A).summary=e),label:"Qisqacha mazmun",placeholder:"Hujjatning qisqacha mazmunini kiriting",error:o(z)?.summary},null,8,["modelValue","error"])])],32)]),r("div",W,[n(u,{variant:"ghost",onClick:N},{default:s(()=>[...l[11]||(l[11]=[p("Bekor qilish",-1)])]),_:1}),n(u,{variant:"primary",onClick:S,loading:o(a).loading},{default:s(()=>[n(o(C)),p(" "+d(o(h).loading?"Yuborilmoqda...":"Saqlash va fayil yuklash"),1)]),_:1},8,["loading"])])])}}};export{X as _,Y as a,I as u};
