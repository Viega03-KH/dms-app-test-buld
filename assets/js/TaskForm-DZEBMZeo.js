import{j as e,l as s,k as a,z as i,B as l,c as t,o as r,e as n,b as o,t as d,w as u,u as c,x as p,P as m,_ as g,F as f,r as b,O as h}from"./vue-vendor-D8IdSx1h.js";import{b as x,j as v}from"./index-Bbk9u_eB.js";import{u as _}from"./taskStore-fg2m-3Kx.js";import{u as j}from"./usersStore-fKCvmNci.js";import{u as y}from"./subjectStore-CApgYJVN.js";import{u as w}from"./useFormValidate-WCLlqkIO.js";import{M as k}from"./MultiColumnUserSelect-BO7eWjXw.js";import{X as T,O as S,Q as q}from"./ui-vendor-Dpi5LIj3.js";const U={class:"w-[100vw] md:w-[80vw] 2xl:w-[50vw] h-[90vh] flex flex-col bg-white rounded-xl shadow-lg"},V={class:"flex justify-between items-center p-4 border-b"},B={class:"font-bold uppercase text-md"},C={class:"p-6 flex-1 h-[calc(80vh-64px)] overflow-y-scroll space-y-6"},F={class:"grid grid-cols-2 gap-4"},z={class:"flex items-center pt-2 justify-start gap-2 col-span-2"},A={class:"relative inline-flex items-center cursor-pointer"},O={class:"flex flex-col gap-2"},$={class:"flex flex-col gap-2"},D={key:0,class:"flex items-center gap-3 w-full px-4 py-3 bg-blue-50 border border-blue-200 rounded-xl shadow-sm animate-pulse"},E={class:"w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center"},M={class:"w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold text-sm"},H={class:"flex flex-col flex-1 leading-tight"},I={class:"text-sm font-medium text-blue-900"},P={class:"text-xs text-blue-600"},K={class:"flex justify-end gap-3 p-4 border-t"},N={__name:"TaskForm",props:{id:Number,existingTask:Object},setup(N){const Q=N,Y=x(),G=_(),J=j(),L=y(),R=e(!1),W=e(!1),X=e({}),{form:Z,errors:ee,validate:se,resetForm:ae}=w({document_id:Q.id,subject_id:null,due_date:"",description:"",assignees_ids:[]},{subject_id:{required:!0,message:"Topshiriq tanlanishi majburiy"},due_date:{required:!0,custom:e=>{if(!e)return"Sana majburiy";return new Date(e).setHours(0,0,0,0)<(new Date).setHours(0,0,0,0)?"Sana bugundan oldingi boâ€˜lishi mumkin emas":""}},description:{required:!0,message:"Mazmuni majburiy"},assignees_ids:{custom:e=>W.value||Array.isArray(e)&&e.length?"":"Kamida bitta ijrochi tanlang"}});s(()=>[J.users,J.searchUsers],([e,s])=>{[...e,...s].forEach(e=>{e?.id&&(X.value[e.id]=e)})},{immediate:!0,deep:!0});const ie=a(()=>{const e={...X.value};return Q.existingTask?.assignees&&Q.existingTask.assignees.forEach(s=>{s?.id&&(e[s.id]=s,X.value[s.id]||(X.value[s.id]=s))}),e}),le=e=>ie.value[e],te=a(()=>{const e=[...J.users||[],...J.searchUsers||[]].filter(Boolean);return[...new Set(e.map(e=>e.id).filter(Boolean))]}),re=e=>{const s=le(e);return s?`${s.first_name} ${s.last_name}`:"Unknown"},ne=e=>{const s=le(e);return s?`${s.first_name?.[0]||""}${s.last_name?.[0]||""}`:"?"},oe=e=>le(e)?.department?.name||"";i(async()=>{await Promise.all([J.fetchUsersForSelect(),L.fetchAll()]),Q.existingTask&&(Z.document_id=Q.existingTask.document?.id||null,Z.subject_id=Q.existingTask.subject?.id||null,Z.due_date=Q.existingTask.due_date||"",Z.description=Q.existingTask.description||"",Z.assignees_ids=Q.existingTask.assignees?.map(e=>e.id)||[],W.value=Z.assignees_ids.length>0&&Z.assignees_ids.length===te.value.length)}),s(W,e=>{Z.assignees_ids=e?te.value.slice():[]});const de=()=>Y.close(),ue=()=>{ae(),de(),W.value=!1},ce=e=>{W.value&&(W.value=!1);const s=Z.assignees_ids.indexOf(e);-1===s?Z.assignees_ids.push(e):Z.assignees_ids.splice(s,1)},pe=async()=>{if(se()){R.value=!0;try{const s={document_id:Z.document_id,subject_id:Z.subject_id,due_date:Z.due_date,description:Z.description,assignees_ids:W.value?["all-users"]:Z.assignees_ids},a=Q.existingTask?await G.updateTask(Q.existingTask.id,s):await G.createTask(s);a.success?ue():"object"==typeof(e=a.error)&&Object.keys(e).forEach(s=>{ee[s]=Array.isArray(e[s])?e[s].join(", "):e[s]})}catch(s){}finally{R.value=!1}var e}};return(e,s)=>{const a=l("UButton"),i=l("USelect"),x=l("UTextarea");return r(),t("div",U,[n("div",V,[n("p",B,d(N.existingTask?"Topshiriqni tahrirlash":"Topshiriq yaratish"),1),o(a,{class:"bg-gray-700 rounded-full p-1",onClick:de},{default:u(()=>[o(c(T),{class:"w-3 h-3 text-white","stroke-width":"3"})]),_:1})]),n("div",C,[n("form",{onSubmit:p(pe,["prevent"]),class:"flex flex-col gap-4"},[n("div",F,[o(i,{modelValue:c(Z).subject_id,"onUpdate:modelValue":s[0]||(s[0]=e=>c(Z).subject_id=e),options:c(L).subjects,label:"Topshiriq",placeholder:"Topshiriq tanlang","option-label":"title","option-value":"id",loading:c(L).loading,error:c(ee).subject_id},null,8,["modelValue","options","loading","error"]),o(v,{modelValue:c(Z).due_date,"onUpdate:modelValue":s[1]||(s[1]=e=>c(Z).due_date=e),label:"Boshlanish sanasi",placeholder:"Sanani tanlang",error:c(ee).due_date},null,8,["modelValue","error"]),n("div",z,[s[7]||(s[7]=n("span",{class:"text-md font-medium"},"Barchasini Ijrochilarni tanlash",-1)),n("label",A,[m(n("input",{type:"checkbox",class:"sr-only peer","onUpdate:modelValue":s[2]||(s[2]=e=>W.value=e)},null,512),[[g,W.value]]),s[5]||(s[5]=n("div",{class:"w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-blue-500 peer-focus:ring-2 peer-focus:ring-blue-300 transition-colors"},null,-1)),s[6]||(s[6]=n("div",{class:"absolute left-0.5 top-0.5 w-5 h-5 bg-white rounded-full peer-checked:translate-x-full transition-transform shadow"},null,-1))])])]),n("div",O,[o(k,{options:c(J).searchUsers,"selected-ids":c(Z).assignees_ids,label:"Ijrochilar",error:c(ee).assignees_ids,onSelect:ce,onSearch:s[3]||(s[3]=e=>c(J).fetchUsersForSelect(e))},null,8,["options","selected-ids","error"]),n("div",$,[W.value?(r(),t("div",D,[n("div",E,[o(c(S),{class:"w-6 h-6"})]),s[8]||(s[8]=n("div",{class:"flex flex-col flex-1"},[n("span",{class:"text-sm font-bold text-blue-900"},"Barcha xodimlar tanlandi"),n("span",{class:"text-xs text-blue-700"},"Topshiriq tizimdagi barcha faol ijrochilarga yuboriladi")],-1))])):(r(!0),t(f,{key:1},b(c(Z).assignees_ids,e=>(r(),t("div",{key:e,class:"relative flex items-center gap-3 w-full px-4 py-2 bg-blue-50 border border-blue-200 rounded-xl"},[n("div",M,d(ne(e)),1),n("div",H,[n("span",I,d(re(e)),1),n("span",P,d(oe(e)),1)]),o(a,{type:"button",onClick:s=>(e=>{W.value&&(W.value=!1),Z.assignees_ids=Z.assignees_ids.filter(s=>s!==e)})(e)},{default:u(()=>[o(c(q),{class:"w-5 h-5 text-gray-400"})]),_:1},8,["onClick"])]))),128))])]),o(x,{modelValue:c(Z).description,"onUpdate:modelValue":s[4]||(s[4]=e=>c(Z).description=e),label:"Topshiriq mazmuni",rows:"4",placeholder:"Topshiriq mazmunini kiriting...",error:c(ee).description},null,8,["modelValue","error"])],32)]),n("div",K,[o(a,{variant:"ghost",onClick:ue},{default:u(()=>[...s[9]||(s[9]=[h("Bekor qilish",-1)])]),_:1}),o(a,{variant:"primary",loading:R.value,disabled:R.value,onClick:pe},{default:u(()=>[h(d(R.value?"Yuborilmoqda...":"Saqlash va yuborish"),1)]),_:1},8,["loading","disabled"])])])}}};export{N as _};
