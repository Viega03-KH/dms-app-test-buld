import{j as e,l as s,k as a,z as i,B as l,c as t,o as r,e as o,b as n,t as d,w as u,u as c,x as p,O as m,_ as f,F as g,r as b,N as h}from"./vue-vendor-VaL6RChx.js";import{b as x,j as v}from"./index-Dz9Hx4OQ.js";import{u as _}from"./taskStore-khsZIx4H.js";import{u as j}from"./usersStore-BRZp8pV1.js";import{u as y}from"./subjectStore-BzFJz3Vr.js";import{u as k}from"./useFormValidate-Wk5HUh9e.js";import{M as w}from"./MultiColumnUserSelect-pQ52tbqU.js";import{X as T,O as q,Q as S}from"./ui-vendor-CHl9FvfL.js";const U={class:"w-[100vw] md:w-[80vw] 2xl:w-[50vw] h-[90vh] flex flex-col bg-white rounded-xl shadow-lg"},V={class:"flex justify-between items-center p-4 border-b"},C={class:"font-bold uppercase text-md"},B={class:"p-6 flex-1 h-[calc(80vh-64px)] overflow-y-scroll space-y-6"},F={class:"grid grid-cols-2 gap-4"},z={class:"flex items-center pt-2 justify-start gap-2 col-span-2"},A={class:"relative inline-flex items-center cursor-pointer"},O={class:"flex flex-col gap-2"},$={class:"flex flex-col gap-2"},D={key:0,class:"flex items-center gap-3 w-full px-4 py-3 bg-blue-50 border border-blue-200 rounded-xl shadow-sm animate-pulse"},E={class:"w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center"},M={class:"w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold text-sm"},H={class:"flex flex-col flex-1 leading-tight"},I={class:"text-sm font-medium text-blue-900"},N={class:"text-xs text-blue-600"},K={class:"flex justify-end gap-3 p-4 border-t"},P={__name:"TaskForm",props:{id:Number,existingTask:Object},setup(P){const Q=P,Y=x(),G=_(),J=j(),L=y(),R=e(!1),W=e(!1),X=e({}),{form:Z,errors:ee,validate:se,resetForm:ae}=k({document_id:Q.id,subject_id:null,due_date:"",description:"",assignees_ids:[]},{subject_id:{required:!0,message:"Topshiriq tanlanishi majburiy"},due_date:{required:!0,custom:e=>{if(!e)return"Sana majburiy";return new Date(e).setHours(0,0,0,0)<(new Date).setHours(0,0,0,0)?"Sana bugundan oldingi boâ€˜lishi mumkin emas":""}},description:{required:!0,message:"Mazmuni majburiy"},assignees_ids:{custom:e=>W.value||Array.isArray(e)&&e.length?"":"Kamida bitta ijrochi tanlang"}});s(()=>[J.users,J.searchUsers],([e,s])=>{[...e,...s].forEach(e=>{e?.id&&(X.value[e.id]=e)})},{immediate:!0,deep:!0});const ie=a(()=>{const e={...X.value};return Q.existingTask?.assignees&&Q.existingTask.assignees.forEach(s=>{s?.id&&(e[s.id]=s,X.value[s.id]||(X.value[s.id]=s))}),e}),le=e=>ie.value[e],te=e=>{const s=le(e);return s?`${s.first_name} ${s.last_name}`:"Unknown"},re=e=>{const s=le(e);return s?`${s.first_name?.[0]||""}${s.last_name?.[0]||""}`:"?"},oe=e=>le(e)?.department?.name||"";i(async()=>{await Promise.all([J.fetchUsersForSelect(),L.fetchAll()]),Q.existingTask&&(Z.document_id=Q.existingTask.document?.id||null,Z.subject_id=Q.existingTask.subject?.id||null,Z.due_date=Q.existingTask.due_date||"",Z.description=Q.existingTask.description||"",Z.assignees_ids=Q.existingTask.assignees?.map(e=>e.id)||[],W.value=Z.assignees_ids.length===J.searchUsers.length)}),s(W,e=>{});const ne=()=>Y.close(),de=()=>{ae(),ne(),W.value=!1},ue=e=>{const s=Z.assignees_ids.indexOf(e);-1===s?Z.assignees_ids.push(e):Z.assignees_ids.splice(s,1)},ce=async()=>{if(se()){R.value=!0;try{const s={document_id:Z.document_id,subject_id:Z.subject_id,due_date:Z.due_date,description:Z.description,assignees_ids:W.value?["all-users"]:Z.assignees_ids},a=Q.existingTask?await G.updateTask(Q.existingTask.id,s):await G.createTask(s);a.success?de():"object"==typeof(e=a.error)&&Object.keys(e).forEach(s=>{ee[s]=Array.isArray(e[s])?e[s].join(", "):e[s]})}catch(s){}finally{R.value=!1}var e}};return(e,s)=>{const a=l("UButton"),i=l("USelect"),x=l("UTextarea");return r(),t("div",U,[o("div",V,[o("p",C,d(P.existingTask?"Topshiriqni tahrirlash":"Topshiriq yaratish"),1),n(a,{class:"bg-gray-700 rounded-full p-1",onClick:ne},{default:u(()=>[n(c(T),{class:"w-3 h-3 text-white","stroke-width":"3"})]),_:1})]),o("div",B,[o("form",{onSubmit:p(ce,["prevent"]),class:"flex flex-col gap-4"},[o("div",F,[n(i,{modelValue:c(Z).subject_id,"onUpdate:modelValue":s[0]||(s[0]=e=>c(Z).subject_id=e),options:c(L).subjects,label:"Topshiriq",placeholder:"Topshiriq tanlang","option-label":"title","option-value":"id",loading:c(L).loading,error:c(ee).subject_id},null,8,["modelValue","options","loading","error"]),n(v,{modelValue:c(Z).due_date,"onUpdate:modelValue":s[1]||(s[1]=e=>c(Z).due_date=e),label:"Boshlanish sanasi",placeholder:"Sanani tanlang",error:c(ee).due_date},null,8,["modelValue","error"]),o("div",z,[s[7]||(s[7]=o("span",{class:"text-md font-medium"},"Barchasini Ijrochilarni tanlash",-1)),o("label",A,[m(o("input",{type:"checkbox",class:"sr-only peer","onUpdate:modelValue":s[2]||(s[2]=e=>W.value=e)},null,512),[[f,W.value]]),s[5]||(s[5]=o("div",{class:"w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-blue-500 peer-focus:ring-2 peer-focus:ring-blue-300 transition-colors"},null,-1)),s[6]||(s[6]=o("div",{class:"absolute left-0.5 top-0.5 w-5 h-5 bg-white rounded-full peer-checked:translate-x-full transition-transform shadow"},null,-1))])])]),o("div",O,[n(w,{options:c(J).searchUsers,"selected-ids":c(Z).assignees_ids,label:"Ijrochilar",error:c(ee).assignees_ids,onSelect:ue,onSearch:s[3]||(s[3]=e=>c(J).fetchUsersForSelect(e))},null,8,["options","selected-ids","error"]),o("div",$,[W.value?(r(),t("div",D,[o("div",E,[n(c(q),{class:"w-6 h-6"})]),s[8]||(s[8]=o("div",{class:"flex flex-col flex-1"},[o("span",{class:"text-sm font-bold text-blue-900"},"Barcha xodimlar tanlandi"),o("span",{class:"text-xs text-blue-700"},"Topshiriq tizimdagi barcha faol ijrochilarga yuboriladi")],-1))])):(r(!0),t(g,{key:1},b(c(Z).assignees_ids,e=>(r(),t("div",{key:e,class:"relative flex items-center gap-3 w-full px-4 py-2 bg-blue-50 border border-blue-200 rounded-xl"},[o("div",M,d(re(e)),1),o("div",H,[o("span",I,d(te(e)),1),o("span",N,d(oe(e)),1)]),n(a,{type:"button",onClick:s=>(e=>{Z.assignees_ids=Z.assignees_ids.filter(s=>s!==e)})(e)},{default:u(()=>[n(c(S),{class:"w-5 h-5 text-gray-400"})]),_:1},8,["onClick"])]))),128))])]),n(x,{modelValue:c(Z).description,"onUpdate:modelValue":s[4]||(s[4]=e=>c(Z).description=e),label:"Topshiriq mazmuni",rows:"4",placeholder:"Topshiriq mazmunini kiriting...",error:c(ee).description},null,8,["modelValue","error"])],32)]),o("div",K,[n(a,{variant:"ghost",onClick:de},{default:u(()=>[...s[9]||(s[9]=[h("Bekor qilish",-1)])]),_:1}),n(a,{variant:"primary",loading:R.value,disabled:R.value,onClick:ce},{default:u(()=>[h(d(R.value?"Yuborilmoqda...":"Saqlash va yuborish"),1)]),_:1},8,["loading","disabled"])])])}}};export{P as _};
